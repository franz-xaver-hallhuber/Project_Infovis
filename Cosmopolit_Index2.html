<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Munich Cosmopolit Index</title>
    <link rel="stylesheet" href="cosmoStyle.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <script type="text/javascript" src="cosmoScript.js"></script>
    <script type="text/javascript" src="processRawData.js"></script>


    <script>

        $(document).ready(function () {

            var allDataCleaned = [];


            // warten bis beide ajax-aufrufe die Daten vom Server haben
            $.when(fetchAussen(), fetchBinnen()).done(function (aussenPackage, binnenPackage) {

                // beide Datensätze zusammenschmeißen in allDataCleaned
                allDataCleaned.push.apply(allDataCleaned, getCleanedAussenwanderung(aussenPackage[0]));
                allDataCleaned.push.apply(allDataCleaned, getCleanedBinnenwanderung(binnenPackage[0]));

                console.log("Formatted both sets and threw them together, now %c" + allDataCleaned.length + "%c items.",
                        "color: blue;",
                        "color: default;");

                console.log("Et voilà: ");
                console.log(allDataCleaned);


            });

            //add arrow svg to each div element
            addSvgs();

            var svgElementInHTMLSite = document.getElementById("alphasvg");

            //it's important to add an load event listener to the object, as it will load the svg doc asynchronously
            svgElementInHTMLSite.addEventListener("load", function () {
                var svgDoc = svgElementInHTMLSite.contentDocument; //get the inner DOM of alpha.svg
                var svgRoot = svgDoc.documentElement;

                var selectedArea;
                var startPoint;
                var endPoint;


                svgRoot.addEventListener("mousemove", function (e) {
                    if (startPoint && !endPoint)
                        drawConnection(svgDoc, startPoint, getCursorPosition(svgRoot, e), false);

                    // TODO checken, ob Verbindung möglich ist
                    // z.B. soll Ausland -> Deutschland nicht die gehighlighted werden
                    // Mauszeiger soll Kreuz werden, falls nicht möglich

                });


                var allAreas = svgRoot.getElementsByTagName("path");
                for (var i = 0; i < allAreas.length; i++) {

                    allAreas[i].addEventListener("mouseover", function (e) {
                        svgRoot.getElementById("area-name").textContent = e.target.id;

                        var areaInfo = allDataCleaned.filter(function(zeile){
                            return zeile.NAME == e.target.id && zeile.JAHR === "2012";
                        });




                    });

                    allAreas[i].addEventListener("click", function (e) {

                        var allDataFromYear2012 = allDataCleaned.filter(function(zeile){
                            return zeile.JAHR == "2012";
                        })

                        var eventArea = e.target;

                        // Deaktiviere Visualisierung, wenn ich erneut auf das aktive Element klicke
                        if ($(selectedArea)[0] === $(eventArea)[0]) {
                            toggleClass($(selectedArea), "selected");
                            selectedArea = null;
                            startPoint = null;
                            removeById(svgRoot, "currentLine");
                            removeById(svgRoot, "currentLineShadow");
                            removeById(svgRoot, "movingCircle");
                            toggleAnimation(false);

                        } else if (selectedArea && !endPoint) { //wenn bereits ein Element ausgewählt ist

                            endPoint = getCursorPosition(svgRoot, e);

                            if(areaIsAussen(selectedArea)){

                                console.log("Startpunkt: außen")

                                if(areaIsInnen(eventArea)){
                                    console.log("Endpunkt: innen");

                                    var shownData = allDataFromYear2012.filter(function(zeile){
                                        return zeile.INDIKATOR_AUSPRAEGUNG == selectedArea.id
                                                && zeile.NAME == eventArea.id;
                                    });

                                } else {
                                    console.log("Endpunkt: außen");
                                }

                            } else {

                                console.log("Startpunkt innen");

                                if(areaIsInnen(eventArea)){
                                    console.log("Endpunkt: innen");

                                    var shownData = allDataFromYear2012.filter(function(zeile){
                                        return zeile.INDIKATOR_AUSPRAEGUNG == $(eventArea).parent().attr('id')
                                                && zeile.NAME == selectedArea.id;
                                    })

                                } else {
                                    console.log("Endpunkt: außen");

                                    var shownData = allDataFromYear2012.filter(function(zeile){
                                        return zeile.INDIKATOR_AUSPRAEGUNG == eventArea.id
                                                && zeile.NAME == selectedArea.id;
                                    })

                                }

                            }

                            console.log(shownData);

                            var value = shownData[0].INDIKATOR_WERT;

                            console.log(value);

                            var sortedData = allDataFromYear2012.sort(function(a,b){
                                if (parseFloat(a.INDIKATOR_WERT) > parseFloat(b.INDIKATOR_WERT)) {
                                    return 1;
                                }
                                if (parseFloat(a.INDIKATOR_WERT) < parseFloat(b.INDIKATOR_WERT)) {
                                    return -1;
                                }
                                // a must be equal to b
                                return 0;
                            });

                            for(var i = 0; i < sortedData.length; i++){
                                console.log(sortedData[i].INDIKATOR_WERT);
                            }
//                            console.log(sortedData);
                            console.log(sortedData[0]);
                            console.log(sortedData[sortedData.length-1]);


                            drawConnection(svgDoc, startPoint, endPoint, true, areaIsInnen(selectedArea), value); //Zeichne Pfad UND starte Animation




                        } else {    // Ansonsten ist das gerade geklickte Element das neue aktive Element

                            toggleClass($(selectedArea), "selected");
                            toggleClass($(eventArea), "selected");

                            endPoint = null;
                            removeById(svgRoot, "currentLine");
                            removeById(svgRoot, "currentLineShadow");
                            removeById(svgRoot, "movingCircle");

                            selectedArea = eventArea;
                            startPoint = getCursorPosition(svgRoot, e);
                            console.log("id=\"" + e.target.id + "\" x=\"" + startPoint.x + "\" y=\"" + startPoint.y + "\"");
                            toggleAnimation(false);


                        }
                    });
                }

            }, false);
        })
    </script>

    <!--
    http://www.mstatistik-muenchen.de/indikatorenatlas/html5/atlas.html?indicator=i57&date=2014
    https://upload.wikimedia.org/wikipedia/commons/5/50/M%C3%BCnchen_-_Stadtbezirke_und_Stadtbezirksteile_%28Karte%29.svg
    http://stackoverflow.com/questions/11808860/arrow-triangles-on-my-svg-line
    -->

    <style>

    </style>
</head>
<body>

<object data="muenchen_exportiert.svg" type="image/svg+xml" id="alphasvg" style="float:left;"></object>
<div id="info"></div>
<arrows>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>
    <div class="arrow"></div>

</arrows>


</body>
</html>