<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Munich Cosmopolit Index</title>
    <link rel="stylesheet" href="cosmoStyle.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <script type="text/javascript" src="cosmoScript.js"></script>
    <script type="text/javascript" src="processRawData.js"></script>

    <todo>
        <item id="todo1">Mehrere Pfeile gleichzeitig</item>
        <item id="todo2">Ganze Stadt highlighten, wenn Startpunkt innerhalb</item>
        <item id="todo3">Slider einbauen mit Jahreszahlen, min und max wert aus Datenbank auslesen</item>
        <item id="todo4">Mit esc linie ziehen abbrechen</item>
    </todo>

    <script>


        $(document).ready(function () {

            var allDataCleaned = [];


            // warten bis beide ajax-aufrufe die Daten vom Server haben
            $.when(fetchAussen(), fetchBinnen()).done(function (aussenPackage, binnenPackage) {

                // beide Datensätze zusammenschmeißen in allDataCleaned
                allDataCleaned.push.apply(allDataCleaned, getCleanedAussenwanderung(aussenPackage[0]));
                allDataCleaned.push.apply(allDataCleaned, getCleanedBinnenwanderung(binnenPackage[0]));

                console.log("Formatted both sets and threw them together, now %c" + allDataCleaned.length + "%c items.",
                        "color: blue;",
                        "color: default;");

                console.log("Et voilà: ");
                console.log(allDataCleaned);


            });

            //add arrow svg to each div element
            addSvgs();

            var svgElementInHTMLSite = document.getElementById("containerSVG");

            //it's important to add an load event listener to the object, as it will load the svg doc asynchronously
            svgElementInHTMLSite.addEventListener("load", function () {
                var svgDoc = svgElementInHTMLSite.contentDocument; //get the inner DOM of alpha.svg
                var svgRoot = svgDoc.documentElement;
                var allAreas = svgRoot.getElementsByTagName("path");

                var selectedArea;
                var startPoint;
                var endPoint;


                svgRoot.addEventListener("mousemove", mouseMoveHandler);

                for (var i = 0; i < allAreas.length; i++) {

                    allAreas[i].addEventListener("mouseover", mouseOverHandler);
                    allAreas[i].addEventListener("mouseout", mouseOutHandler);
                    allAreas[i].addEventListener("click", mouseClickHandler);
                }








                // redraws non-animated connection while mouse is moving
                function mouseMoveHandler(event){
                    if (startPoint && !endPoint){
                        drawConnection(svgDoc, startPoint, getCursorPosition(svgRoot, event), false);
                    }
                }








                function mouseOverHandler(event){

                    var hoveredArea = event.target;

                    // Show info of hovered Area
                    svgRoot.getElementById("area-name").textContent = hoveredArea.id;
                    var areaInfo = allDataCleaned.filter(function(zeile){
                        return zeile.NAME == hoveredArea.id && zeile.JAHR === "2012";
                    });


                    if(     // block cursor and hovered-state if action is not possible
                    (selectedArea && areaIsAussen(selectedArea) && areaIsAussen(hoveredArea))   //außen-außen
                    || selectedArea == hoveredArea  // auf selbe area
                    ) {
                        hoveredArea.style.cursor = "auto";
                        removeClass($(hoveredArea), "hovered");
                    }

                    else {       // action is possible

                        hoveredArea.style.cursor = "pointer";

                        if(areaIsInnen(selectedArea) && areaIsInnen(hoveredArea)) {     // hover ALL of Munich if we're inside
                            addClass($(hoveredArea).parent().children(), "hovered");
                        }

                        else {      // hover only hovered Element if we're not entirely in Munich
                            addClass($(hoveredArea), "hovered");
                        }
                    }
                }







                function mouseOutHandler(event) {
                    var unHoveredArea = event.target;

                    removeClass($(unHoveredArea), "hovered");

                    // if all of Munich was hovered (area inside selected && area inside hovered
                    if (areaIsInnen(unHoveredArea)) {
                        removeClass($(unHoveredArea).parent().children(), "hovered");
                    }
                }








                function mouseClickHandler(event) {

                    // deactivate hover-behavior if I actually CLICKED on that element
                    mouseOutHandler(event);

                    var clickedArea = event.target;

                    if (selectedArea) { //wenn bereits ein Element ausgewählt ist

                        if (selectedArea == clickedArea) {
                            deletePath();
                        } else {

                            endPoint = getCursorPosition(svgRoot, event);
                            var dataToShow = getDataToShow(selectedArea, clickedArea);
                            console.log(dataToShow);

                            if(dataToShow != null){

                                drawConnection(svgDoc, startPoint, endPoint, true, areaIsInnen(selectedArea), dataToShow[0]); //Zeichne Pfad UND starte Animation
                                removeClass($(selectedArea), "selected");
                                selectedArea = null;
                                startPoint = null;
                                endPoint = null;

                            }
                        }

                    } else {    // Ansonsten ist das gerade geklickte Element das neue aktive Element

                        selectedArea = clickedArea;
                        addClass($(selectedArea), "selected");

                        removeById(svgRoot, "currentLine");
                        removeById(svgRoot, "currentLineShadow");
                        removeById(svgRoot, "movingCircle");

                        startPoint = getCursorPosition(svgRoot, event);
                        removeDivs();
                    }
                }







                function deletePath(){
                    toggleClass($(selectedArea), "selected");
                    selectedArea = null;
                    startPoint = null;
                    endPoint = null;
                    removeById(svgRoot, "currentLine");
                    removeById(svgRoot, "currentLineShadow");
                    removeById(svgRoot, "movingCircle");
//                    toggleAnimation(false);
                    removeDivs();

                }








                function getDataToShow(selectedArea, clickedArea) {

                    var allDataFromYear2012 = allDataCleaned.filter(function(zeile){
                        return zeile.JAHR == "2012";
                    })

                    if (areaIsAussen(selectedArea)) {     // starts außen

                        if (areaIsInnen(clickedArea)) {       // ends innen

                            return allDataFromYear2012.filter(function (zeile) {
                                return zeile.INDIKATOR_AUSPRAEGUNG == selectedArea.id
                                        && zeile.NAME == clickedArea.id;
                            });

                        } else {        // ends außen
                            deletePath();
                            return null;
                        }

                    } else {        //starts innen

                        if (areaIsInnen(clickedArea)) {       //ends innen

                            return allDataFromYear2012.filter(function (zeile) {
                                return zeile.INDIKATOR_AUSPRAEGUNG == $(clickedArea).parent().attr('id')
                                        && zeile.NAME == selectedArea.id;
                            })

                        } else {        // ends außen

                            return allDataFromYear2012.filter(function (zeile) {
                                return zeile.INDIKATOR_AUSPRAEGUNG == clickedArea.id
                                        && zeile.NAME == selectedArea.id;
                            })

                        }

                    }
                }


            }, false);
        })
    </script>

    <!--
        http://www.mstatistik-muenchen.de/indikatorenatlas/html5/atlas.html?indicator=i57&date=2014
    https://upload.wikimedia.org/wikipedia/commons/5/50/M%C3%BCnchen_-_Stadtbezirke_und_Stadtbezirksteile_%28Karte%29.svg
    http://stackoverflow.com/questions/11808860/arrow-triangles-on-my-svg-line
    -->

    <style>

    </style>
</head>
<body>

<div style="float:left; display: block; border: 1px solid red;">
    <object data="muenchen_exportiert.svg" type="image/svg+xml" id="containerSVG"></object>
</div>
<div style="border:1px solid green; display: block;">blasdklajlkjds</div>
<div id="info"></div>
<div id="arrowContainer">

</div>


</body>
</html>